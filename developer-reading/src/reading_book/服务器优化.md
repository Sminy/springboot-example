## 服务器优化

### 1 线程核心数配置

一般说来，大家认为线程池的大小经验值应该这样设置：（其中N为CPU的个数）

- 如果是CPU密集型应用，则线程池大小设置为N+1
- 如果是IO密集型应用，则线程池大小设置为2N+1

![](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210713144522118.png)

**最佳线程数目 = （（线程等待时间+线程CPU时间）/线程CPU时间 ）* CPU数目**



### 2 线程模型

 线程是调度CPU最小单元，也叫轻量级进程LWP（Light weight process）

**内核级线程**（Kemel-Level Threads, KLT）

- 进程中的一个线程被阻塞，内核能调度同一进程的其他线程（就绪态）占有处理器运行

- 多处理器环境中，内核能同时调度同一进程的多线程，将这些线程映射到不同的处理器核心上，提高进程的执行效率。

- 应用程序线程在用户态运行，线程调度和管理在内核实现。线程调度时，控制权从一个线程改变到另一线程，需要模式切换，系统开销较大。

  

**用户级线程**（User-Level Threads ULT）：

- 用户空间运行线程库，任何应用程序都可以通过使用线程库被设计成多线程程序。线程库是用于用户级线程管理的一个例程包，它提供多线程应用程序的开发和运行支撑环境，包含：用于创建和销毁线程的代码、在线程间传递数据和消息的代码、调度线程执行的代码以及保存和恢复线程上下文的代码。

- 所以线程的创建，消息传递，调度，保存/恢复上下文都有线程库来完成。内核感知不到多线程的存在。内核继续以进程为调度单位，并且给该进程指定一个执行状态（就绪、运行、阻塞等）。

  

  jacketing技术可以解决ULT一个线程阻塞导致整个进程阻塞。、

  

**两者区别：**

```
用户级线程（ULT）：用户程序实现，不依赖操作系统核心，应用提供创建、同步、调度和管理线程函数来控制用户线程。不需要用户态/核心态切换，速度快。内核对ULT无感知，线程阻塞则进程（包括它所有的线程）阻塞
内核级线程（KLT）:系统内核管理线程（KLT），内核保存线程的状态和上下文信息，线程组设不会引起进程阻塞。在多处理器系统上，多线程在多处理器上并行运行线程的创建、调度和管理由内核完成，效率要比ULT慢，比进程操作快。
```

![img](https://img-blog.csdnimg.cn/20201030172242339.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNjQwMTAz,size_16,color_FFFFFF,t_70#pic_center)