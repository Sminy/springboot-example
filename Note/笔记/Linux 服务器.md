## Linux 服务器

### 1. top

<img src=".\img\Linux_top.png" alt="image-20210729171500258" style="zoom:50%;" />

| 内容                           | 含义                                                         |
| :----------------------------- | :----------------------------------------------------------- |
| 05:43:27                       | 表示当前时间                                                 |
| up 4:52                        | 系统运行时间 格式为时：分                                    |
| 2 users                        | 当前登录用户数                                               |
| load average: 0.58, 0.41, 0.30 | 系统负载，即任务队列的平均长度。 三个数值分别为 1分钟、5分钟、15分钟前到现在的平均值。 |

注意: load average: 三个值的平均值/cpu核数，结果高于5的时候就表明系统在超负荷运转了。 

进入top视图后：

- 按数字“1” 键可以监控每个cpu的状况
- 敲击键盘‘b’（打开关闭加亮效果）
- 敲击键盘‘x’（打开/关闭排序列的加亮效果）
-  P 键：以CPU的使用资源排序显示 
- M 键：以内存的使用资源排序显示 
- N 键：以pid排序显示 
- T 键：由进程使用的时间累计排序显示
-  k 键：给某一个pid一个信号。可以用来杀死进程 

### 2. uptime

top  系统性能命令的精简版

```
17:27:36 up 148 days, 23:44,  2 users,  load average: 0.00, 0.01, 0.05
```

### 3. vmstat

```
vmstat -n 2 3
```

**procs**

- r：运行和等待的CPU时间片的进程数，原则上1核的CPU的运行队列不要超过2，整个系统的运行队列不超过总核数的2倍，否则代表系统压力过大，我们看蘑菇博客测试服务器，能发现都超过了2，说明现在压力过大
- b：等待资源的进程数，比如正在等待磁盘I/O、网络I/O等

**cpu**

- us：用户进程消耗CPU时间百分比，us值高，用户进程消耗CPU时间多，如果长期大于50%，优化程序
- sy：内核进程消耗的CPU时间百分比
- us + sy 参考值为80%，如果us + sy 大于80%，说明可能存在CPU不足，从上面的图片可以看出，us + sy还没有超过百分80，因此说明蘑菇博客的CPU消耗不是很高
- id：处于空闲的CPU百分比
- wa：系统等待IO的CPU时间百分比
- st：来自于一个虚拟机偷取的CPU时间比



### 4. pidstat

pidstat是sysstat工具的一个命令，用于监控全部或指定进程的cpu、内存、线程、设备IO等系统资源的占用情况

```
pidstat [ 选项 ] [ <时间间隔> ] [ <次数> ]
```

**安装sysstat 模块：**

1. 服务端安装 sysstat 模块 yum install sysstat
2. ps -ef|grep java
3. pidstat -u 1 -p 进程编号



**常用的参数：**

- -u：默认的参数，显示各个进程的cpu使用统计
- -r：显示各个进程的内存使用统计
- -d：显示各个进程的IO使用情况
- -p：指定进程号
- -w：显示每个进程的上下文切换情况
- -t：显示选择任务的线程的统计信息外的额外信息
- -T { TASK | CHILD | ALL }
   这个选项指定了pidstat监控的。TASK表示报告独立的task，CHILD关键字表示报告进程下所有线程统计信息。ALL表示报告独立的task和task下面的所有线程。
   注意：task和子线程的全局的统计信息和pidstat选项无关。这些统计信息不会对应到当前的统计间隔，这些统计信息只有在子线程kill或者完成的时候才会被收集。
- -V：版本号
- -h：在一行上显示了所有活动，这样其他程序可以容易解析。
- -I：在SMP环境，表示任务的CPU使用率/内核数量
- -l：显示命令名和所有参数



1. 查看所有进程cpu使用情况：

```
mpstat -P ALL 2
```

2.  cpu 使用情况统计

   ```
   pidstat -u
   ```

3.  内存使用情况

   ```
   pidstat -r
   ```

4.  查看某个进程每隔2秒统计cpu使用情况

   ```
   pidstat -u 2 -p 31670
   ```

   

### 5.  free 内存

应用程序可用内存数，经验值：

- 应用程序可用内存l系统物理内存>70%内存充足
- 应用程序可用内存/系统物理内存<20%内存不足，需要增加内存
- 20%<应用程序可用内存/系统物理内存<70%内存基本够用

free -h 友好输出：

![image-20210729174821021](.\img\linux_free.png)

下面先解释一下输出的内容：
**Mem** 行(第二行)是内存的使用情况。
**Swap** 行(第三行)是交换空间的使用情况。
**total** 列显示系统总的可用物理内存和交换空间大小。
**used** 列显示已经被使用的物理内存和交换空间。
**free** 列显示还有多少物理内存和交换空间可用使用。
**shared** 列显示被共享使用的物理内存大小。
**buff/cache** 列显示被 buffer 和 cache 使用的物理内存大小。
**available** 列显示还可以被应用程序使用的物理内存大小。



### 6  df 磁盘

```
df -h
```



### 7. 磁盘 io

磁盘I/O性能评估

```
iostat -xdk 2 3
```

![image-20210729175858246](.\img\linux_iostat.png)

磁盘块设备分布

- rkB/s每秒读取数据量kB;wkB/s每秒写入数据量kB;
- svctm lO请求的平均服务时间，单位毫秒;
- await l/O请求的平均等待时间，单位毫秒;值越小，性能越好;
- util一秒中有百分几的时间用于I/O操作。接近100%时，表示磁盘带宽跑满，需要优化程序或者增加磁盘;
- rkB/s、wkB/s根据系统应用不同会有不同的值，但有规律遵循:长期、超大数据读写，肯定不正常，需要优化程序读取。
- svctm的值与await的值很接近，表示几乎没有IO等待，磁盘性能好。
- 如果await的值远高于svctm的值，则表示IO队列等待太长，需要优化程序或更换更快磁盘。



### 8.  网络 io

ifstat工具是个网络接口监测工具,比较简单看网络流量

```
ifstat -a 
```

![image-20210729180333556](.\img\linux_ifstat.png)



### CPU占用过高的定位分析思路

结合Linux和JDK命令一块分析

案例步骤

- 先用top命令找出CPU占比最高的

  ```
  1、top
  2、shift + p 查看cpu 占用最高的进程
  ```

  ![img](.\img\linux_top_cpu.png)

  

- ps -ef或者jps进一步定位，得知是一个怎么样的一个后台程序作搞屎棍

  ```
  jps -l
  ```

  ```
  ps -ef | grep java |grep -v grep
  ```

- 定位到具体线程或者代码

  - ps -mp 进程 -o THREAD,tid,time  

    ```shell
    ps -mp pid -o THREAD,tid,time
    ```

    - -m 显示所有的线程
    - -p pid进程使用cpu的时间
    - -o 该参数后是用户自定义格式

  ![img](D:\IdeaProjects\springboot-xxx-example\Note\笔记\img\linux_psmp.png)

- 将需要的线程ID转换为16进制格式（英文小写格式），命令printf %x 172 将172转换为十六进制

- ```
  jstack 进程ID | grep tid（16进制线程ID小写英文）-A60
  ```

  